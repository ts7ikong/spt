# 数据权限过滤使用说明

## 概述

本系统实现了基于登录用户区县编码（orgCode）的数据权限过滤功能，支持以下三种类型的表：

1. **直接包含区县编码的表**（如：accept_company.countycode，yqjbxx.park_area_code）
2. **包含企业编码的表**（如：companyCode、reportCompanyCode字段）
3. **包含园区编码的表**（如：parkCode字段）

## 核心组件

### 1. DataScopeHelper 工具类

位置：`jeecg-boot-base-core/src/main/java/org/jeecg/common/util/DataScopeHelper.java`

提供以下静态方法：

```java
// 获取当前登录用户的区县编码
String orgCode = DataScopeHelper.getCurrentUserOrgCode();

// 为QueryWrapper添加区县编码过滤（用于直接包含countycode字段的表）
DataScopeHelper.applyOrgCodeFilter(queryWrapper, "countycode");

// 为QueryWrapper添加企业编码过滤（用于包含companyCode字段的表）
DataScopeHelper.applyCompanyCodeFilter(queryWrapper, companyCodes, "company_code");

// 为QueryWrapper添加园区编码过滤（用于包含parkCode字段的表）
DataScopeHelper.applyParkCodeFilter(queryWrapper, parkCodes, "park_code");
```

### 2. AcceptCompanyService

新增方法：根据区县编码获取企业编码列表

```java
List<String> getCompanyCodesByCountyCode(String countycode);
```

### 3. YqjbxxService

新增方法：根据园区行政区划编码获取园区编码列表

```java
List<String> getParkCodesByAreaCode(String parkAreaCode);
```

## 使用场景与示例

### 场景1：表直接包含区县编码字段

**适用表**：
- `accept_company` (字段：`countycode`)
- `yqjbxx` (字段：`park_area_code`)

**示例代码**：

```java
@GetMapping(value = "/list")
public Result<IPage<AcceptCompany>> queryPageList(AcceptCompany acceptCompany,
                                   @RequestParam(name="pageNo", defaultValue="1") Integer pageNo,
                                   @RequestParam(name="pageSize", defaultValue="10") Integer pageSize,
                                   HttpServletRequest req) {
    QueryWrapper<AcceptCompany> queryWrapper = QueryGenerator.initQueryWrapper(acceptCompany, req.getParameterMap());

    // 【数据权限过滤】根据登录用户的区县编码过滤数据
    DataScopeHelper.applyOrgCodeFilter(queryWrapper, "countycode");

    Page<AcceptCompany> page = new Page<>(pageNo, pageSize);
    IPage<AcceptCompany> pageList = acceptCompanyService.page(page, queryWrapper);
    return Result.OK(pageList);
}
```

**说明**：
- 第二个参数是数据库字段名（使用下划线命名）
- 如果表字段名为 `park_area_code`，则传入 `"park_area_code"`

### 场景2：表包含企业编码字段（companyCode）

**适用表**：
- `qylszdhygx` (字段：`companyCode`)
- `wxhxpxx` (字段：`companyCode`)
- `qyzdjggyxx` (字段：`companyCode`)
- 等所有包含 `companyCode` 字段的表

**示例代码**：

```java
@Autowired
private IAcceptCompanyService acceptCompanyService;

@GetMapping(value = "/list")
public Result<IPage<YourEntity>> queryPageList(YourEntity entity,
                                   @RequestParam(name="pageNo", defaultValue="1") Integer pageNo,
                                   @RequestParam(name="pageSize", defaultValue="10") Integer pageSize,
                                   HttpServletRequest req) {
    QueryWrapper<YourEntity> queryWrapper = QueryGenerator.initQueryWrapper(entity, req.getParameterMap());

    // 【数据权限过滤】根据登录用户的区县编码获取企业列表，然后过滤
    String orgCode = DataScopeHelper.getCurrentUserOrgCode();
    if (orgCode != null && !orgCode.isEmpty()) {
        // 1. 根据区县编码获取企业编码列表
        List<String> companyCodes = acceptCompanyService.getCompanyCodesByCountyCode(orgCode);

        // 2. 应用企业编码过滤
        DataScopeHelper.applyCompanyCodeFilter(queryWrapper, companyCodes, "company_code");
    }

    Page<YourEntity> page = new Page<>(pageNo, pageSize);
    IPage<YourEntity> pageList = yourService.page(page, queryWrapper);
    return Result.OK(pageList);
}
```

**注意**：
- 需要注入 `IAcceptCompanyService`
- 第三个参数是数据库字段名（如：`company_code`）
- 如果实体类使用驼峰命名，MyBatis-Plus会自动转换

### 场景3：表包含上报企业编码字段（reportCompanyCode）

**适用表**：
- `contractorBasicInfo` (字段：`reportCompanyCode`)
- `contractorUserInfo` (字段：`reportCompanyCode`)
- `contractorTrainingRecord` (字段：`reportCompanyCode`)
- 等所有第三方单位相关表

**示例代码**：

```java
@Autowired
private IAcceptCompanyService acceptCompanyService;

@GetMapping(value = "/list")
public Result<IPage<ContractorBasicInfo>> queryPageList(ContractorBasicInfo entity,
                                   @RequestParam(name="pageNo", defaultValue="1") Integer pageNo,
                                   @RequestParam(name="pageSize", defaultValue="10") Integer pageSize,
                                   HttpServletRequest req) {
    QueryWrapper<ContractorBasicInfo> queryWrapper = QueryGenerator.initQueryWrapper(entity, req.getParameterMap());

    // 【数据权限过滤】根据登录用户的区县编码获取企业列表，然后过滤
    String orgCode = DataScopeHelper.getCurrentUserOrgCode();
    if (orgCode != null && !orgCode.isEmpty()) {
        List<String> companyCodes = acceptCompanyService.getCompanyCodesByCountyCode(orgCode);

        // 注意：这里字段名是 report_company_code
        DataScopeHelper.applyCompanyCodeFilter(queryWrapper, companyCodes, "report_company_code");
    }

    Page<ContractorBasicInfo> page = new Page<>(pageNo, pageSize);
    IPage<ContractorBasicInfo> pageList = contractorBasicInfoService.page(page, queryWrapper);
    return Result.OK(pageList);
}
```

### 场景4：表包含园区编码字段（parkCode）

**适用表**：
- `jxkml` (字段：`parkCode`)
- `zbzsxx` (字段：`parkCode`)
- `zfjcjhglxx` (字段：`parkCode`)
- 等所有园区相关表

**示例代码**：

```java
@Autowired
private IYqjbxxService yqjbxxService;

@GetMapping(value = "/list")
public Result<IPage<YourParkEntity>> queryPageList(YourParkEntity entity,
                                   @RequestParam(name="pageNo", defaultValue="1") Integer pageNo,
                                   @RequestParam(name="pageSize", defaultValue="10") Integer pageSize,
                                   HttpServletRequest req) {
    QueryWrapper<YourParkEntity> queryWrapper = QueryGenerator.initQueryWrapper(entity, req.getParameterMap());

    // 【数据权限过滤】根据登录用户的区县编码获取园区列表，然后过滤
    String orgCode = DataScopeHelper.getCurrentUserOrgCode();
    if (orgCode != null && !orgCode.isEmpty()) {
        // 1. 根据园区行政区划编码获取园区编码列表
        List<String> parkCodes = yqjbxxService.getParkCodesByAreaCode(orgCode);

        // 2. 应用园区编码过滤
        DataScopeHelper.applyParkCodeFilter(queryWrapper, parkCodes, "park_code");
    }

    Page<YourParkEntity> page = new Page<>(pageNo, pageSize);
    IPage<YourParkEntity> pageList = yourParkService.page(page, queryWrapper);
    return Result.OK(pageList);
}
```

## 实施步骤

### 第一步：在Controller中添加必要的import

```java
import org.jeecg.common.util.DataScopeHelper;
// 如果是企业相关表，还需要：
import org.jeecg.modules.sptsjzx.qyaqjcgl.qyjbxx.qyjbxx.service.IAcceptCompanyService;
// 如果是园区相关表，还需要：
import org.jeecg.modules.sptsjzx.aqjcgl.yqjcxxgl.yqjbxx.service.IYqjbxxService;
```

### 第二步：注入必要的Service

```java
// 如果是企业相关表
@Autowired
private IAcceptCompanyService acceptCompanyService;

// 如果是园区相关表
@Autowired
private IYqjbxxService yqjbxxService;
```

### 第三步：在list方法中添加数据权限过滤

根据表的类型，选择对应的过滤方式（参考上面的场景示例）。

## 接口清单与对应方案

### 直接包含区县编码的表（使用场景1）

```
sptsjzx/qyaqjcgl/qyjbxx/qyjbxx/acceptCompany/list  ✓ 已实现
```

### 包含companyCode字段的表（使用场景2）

```
sptsjzx/qyaqjcgl/qyjbxx/qylszdhygx/qylszdhygx/list
sptsjzx/qyaqjcgl/qyjbxx/wxhxpxx/wxhxpxx/list
sptsjzx/qyaqjcgl/qyjbxx/qyzdjggyxx/qyzdjggyxx/list
sptsjzx/qyaqjcgl/qyjbxx/zdwxyxx/acceptHazardCode/list
sptsjzx/qyaqjcgl/qyjbxx/wxyhxpxx/wxyhxpxx/list
sptsjzx/qyaqjcgl/qyjbxx/wxybbzrrxx/wxybbfzrxx/list
sptsjzx/qyaqjcgl/qyjbxx/ryxxk/ryxxk/list
sptsjzx/qyaqjcgl/qyjbxx/qysgsj/qysgsj/list
sptsjzx/qyaqjcgl/zysbsssj/jcsbxx/sbxx/deviceBaseInfo/list
sptsjzx/qyaqjcgl/zysbsssj/jcsbxx/cgjcxx/tankDeviceInfo/list
sptsjzx/qyaqjcgl/zysbsssj/jcsbxx/zzxx/deviceProcessSafety/list
sptsjzx/qyaqjcgl/zysbsssj/jcsbxx/qtxldjcxx/deviceGasSensor/list
... (还有很多其他表)
```

### 包含reportCompanyCode字段的表（使用场景3）

```
sptsjzx/dsfdwgl/dsfdwjbxx/contractorBasicInfo/list
sptsjzx/dsfdwgl/dsfry/contractorUserInfo/list
sptsjzx/dsfdwgl/dsfpxjl/contractorTrainingRecord/list
sptsjzx/dsfdwgl/dsfzzxx/contractorQualificationInfo/list
sptsjzx/dsfdwgl/dsfwgjl/contractorViolationRecord/list
```

### 包含parkCode字段的表（使用场景4）

```
sptsjzx/aqjcgl/aqscxzxkgl/yqjbxx/yqjbxx/list  ✓ 已实现
sptsjzx/aqjcgl/aqscxzxkgl/jxkml/jxkml/list
sptsjzx/aqjcgl/qyjcxx/zbzsxx/zbzsxx/list
sptsjzx/aqjcgl/zfjcgl/zfjcjhglxx/zfjcjhglxx/list
sptsjzx/aqjcgl/zfjcgl/zfjcjlxx/zfjcjlxx/list
... (还有很多其他表)
```

## 注意事项

1. **字段名称**：MyBatis-Plus支持驼峰命名和下划线命名自动转换
   - 实体类：`companyCode`
   - 数据库：`company_code`
   - QueryWrapper可以使用任意一种，推荐使用下划线命名与数据库保持一致

2. **性能优化**：
   - `getCompanyCodesByCountyCode()` 和 `getParkCodesByAreaCode()` 方法只查询code字段，避免全字段查询
   - 建议在 `countycode`、`park_area_code` 字段上建立索引

3. **空结果处理**：
   - 如果区县下没有企业或园区，会应用 `1=0` 条件，返回空列表
   - 这是正常的权限控制行为

4. **管理员权限**：
   - 如果需要让某些角色（如管理员）不受数据权限限制，可以在应用过滤前添加判断：
   ```java
   if (DataScopeHelper.needDataScope()) {
       // 应用数据权限过滤
   }
   ```

5. **批量修改**：
   - 建议使用IDE的全局搜索替换功能批量修改所有Controller
   - 搜索关键字：`QueryWrapper.*queryWrapper.*QueryGenerator.initQueryWrapper`

## 测试建议

1. 使用不同区县的用户登录测试
2. 验证只能查看本区县的数据
3. 验证企业和园区的关联查询正确性
4. 测试边界情况（如区县下没有企业/园区）

## 示例Controller完整代码

完整的Controller示例可以参考：
- `AcceptCompanyController.java:83-109` - 企业表示例
- `YqjbxxController.java:54-72` - 园区表示例
