<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.sptsjzx.qyaqjcgl.statistics.mapper.SpecialWorkStatisticsMapper">

    <!-- 1. 作业票接入情况统计 -->
    <select id="getTicketAccessStats" resultType="map">
        SELECT
        COUNT(CASE WHEN ticket_state = '1' AND ticket_activity = '1' THEN 1 END) as fullAccess,
        COUNT(CASE WHEN (ticket_state = '0' AND ticket_activity = '1') OR (ticket_state = '1' AND ticket_activity = '0') THEN 1 END) as partialAccess,
        COUNT(CASE WHEN ticket_state = '0' AND ticket_activity = '0' THEN 1 END) as notAccess,
        COUNT(*) as total
        FROM zlkj_danger_data_accept.all_access_status a
        <where>
            <if test="countycode != null and countycode != ''">
                EXISTS (
                SELECT 1 FROM zlkj_danger_data_accept.accept_company c
                WHERE c.code = a.company_code
                AND c.countycode = #{countycode}
                )
            </if>
            <if test="yqType != null">
                AND EXISTS (
                SELECT 1 FROM zlkj_danger_data_accept.accept_company c
                WHERE c.code = a.company_code
                AND c.yq_type = #{yqType}
                )
            </if>
            <if test="companyCode != null and companyCode != ''">
                AND a.company_code = #{companyCode}
            </if>
            <if test="isScqy != null">
                AND EXISTS (
                SELECT 1 FROM zlkj_danger_data_accept.accept_company c
                WHERE c.code = a.company_code
                AND c.is_scqy = #{isScqy}
                )
            </if>
        </where>
    </select>

    <!-- 2. 作业票状态统计(饼图) -->
    <select id="getTicketStatusStats" resultType="map">
        SELECT
        CASE t.ticket_status
        WHEN '0' THEN '未签发'
        WHEN '1' THEN '已签发'
        WHEN '3' THEN '已验收'
        WHEN '4' THEN '作废'
        WHEN '5' THEN '撤销'
        ELSE '未知'
        END as name,
        COUNT(*) as value
        FROM zlkj_danger_data_accept.accept_ticket_formal t
        <if test="countycode != null and countycode != '' or yqType != null or isScqy != null">
            LEFT JOIN zlkj_danger_data_accept.accept_company c ON t.company_code = c.code
        </if>
        <where>
            t.deleted = 0
            <if test="countycode != null and countycode != ''">
                AND c.countycode = #{countycode}
            </if>
            <if test="yqType != null">
                AND c.yq_type = #{yqType}
            </if>
            <if test="companyCode != null and companyCode != ''">
                AND t.company_code = #{companyCode}
            </if>
            <if test="isScqy != null">
                AND c.is_scqy = #{isScqy}
            </if>
        </where>
        GROUP BY t.ticket_status
    </select>

    <!-- 3. 作业大类统计(柱状图) -->
    <select id="getTicketTypeStats" resultType="map">
        SELECT
        COALESCE(z.zydl, '未分类') as name,
        COUNT(*) as value
        FROM zlkj_danger_data_accept.accept_ticket_formal t
        LEFT JOIN zlkj_danger_data_accept.zylxflb z ON t.ticket_type = z.xlbm
        <if test="countycode != null and countycode != '' or yqType != null or isScqy != null">
            LEFT JOIN zlkj_danger_data_accept.accept_company c ON t.company_code = c.code
        </if>
        <where>
            t.deleted = 0
            <if test="countycode != null and countycode != ''">
                AND c.countycode = #{countycode}
            </if>
            <if test="yqType != null">
                AND c.yq_type = #{yqType}
            </if>
            <if test="companyCode != null and companyCode != ''">
                AND t.company_code = #{companyCode}
            </if>
            <if test="isScqy != null">
                AND c.is_scqy = #{isScqy}
            </if>
        </where>
        GROUP BY z.zydl
        ORDER BY value DESC
    </select>

    <!-- 4. 作业票总数统计 -->
    <select id="getTicketTotalCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM zlkj_danger_data_accept.accept_ticket_formal t
        <if test="countycode != null and countycode != '' or yqType != null or isScqy != null">
            LEFT JOIN zlkj_danger_data_accept.accept_company c ON t.company_code = c.code
        </if>
        <where>
            t.deleted = 0
            <if test="countycode != null and countycode != ''">
                AND c.countycode = #{countycode}
            </if>
            <if test="yqType != null">
                AND c.yq_type = #{yqType}
            </if>
            <if test="companyCode != null and companyCode != ''">
                AND t.company_code = #{companyCode}
            </if>
            <if test="isScqy != null">
                AND c.is_scqy = #{isScqy}
            </if>
        </where>
    </select>

</mapper>